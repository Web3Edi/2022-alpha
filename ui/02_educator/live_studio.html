<!DOCTYPE html>
<html>
<head>
	<!-- Basic Page Info -->
	<meta charset="utf-8">
	<title>Web 3 Edi - Live Studio</title>

	<!-- Site favicon -->
	<link rel="apple-touch-icon" sizes="180x180" href="../00_service_assets/main/images/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../00_service_assets/main/images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../00_service_assets/main/images/favicon-16x16.png">

	<!-- Mobile Specific Metas -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- Google Font -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<!-- CSS -->
	<link rel="stylesheet" type="text/css" href="../00_service_assets/main/styles/core.css">
	<link rel="stylesheet" type="text/css" href="../00_service_assets/main/styles/icon-font.min.css">
	
	<link rel="stylesheet" type="text/css" href="../00_service_assets/main/styles/style.css">

	<!-- Broadcast -->
	<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

	<!-- Web 3 -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ethjs@0.3.4/dist/ethjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>


	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-119386393-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-119386393-1');
	</script>
</head>
<body>
	<div class="pre-loader">
		<div class="pre-loader-box">
			<div class="loader-logo"><img src="../00_service_assets/main/images/deskapp-logo.svg" alt=""></div>
			<div class='loader-progress' id="progress_div">
				<div class='bar' id='bar1'></div>
			</div>
			<div class='percent' id='percent1'>0%</div>
			<div class="loading-text">
				Loading...
			</div>
		</div>
	</div>

	<!-- NEW HEADER -->
	<div class="header">
		<div class="header-left">
			<div class="menu-icon dw dw-menu"></div>
			<div class="search-toggle-icon dw dw-search2" data-toggle="header_search"></div>
			<div class="header-search">
				<form>
					<div class="form-group mb-0">
						<i class="dw dw-search2 search-icon"></i>
						<input type="text" class="form-control search-input" placeholder="Search Here">
						<div class="dropdown">
							<a class="dropdown-toggle no-arrow" href="#" role="button" data-toggle="dropdown">
								<i class="ion-arrow-down-c"></i>
							</a>
							<div class="dropdown-menu dropdown-menu-right">
								<div class="form-group row">
									<label class="col-sm-12 col-md-2 col-form-label">From</label>
									<div class="col-sm-12 col-md-10">
										<input class="form-control form-control-sm form-control-line" type="text">
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-12 col-md-2 col-form-label">To</label>
									<div class="col-sm-12 col-md-10">
										<input class="form-control form-control-sm form-control-line" type="text">
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-12 col-md-2 col-form-label">Subject</label>
									<div class="col-sm-12 col-md-10">
										<input class="form-control form-control-sm form-control-line" type="text">
									</div>
								</div>
								<div class="text-right">
									<button class="btn btn-primary">Search</button>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
		<div class="header-right">
		
			<div class="user-info-dropdown">
				<div class="dropdown">
					<a class="dropdown-toggle" href="#" role="button" >
						<span id="show_wallet" class="user-name"></span>
						<span id="connect_web_3" class="user-name">Connect Web 3</span>
						<span class="user-icon">
							<img src="../00_service_assets/main/images/android-icon-192x192.png" alt="">
						</span>
						
					</a>
					
				</div>
			</div>
		</div>
	</div>
	<!-- END NEW HEADER -->

	<div class="left-side-bar">
		<div class="brand-logo">
			<a href="../01_campus/index.html">
				<img src="../00_service_assets/main/images/deskapp-logo.svg" alt="" class="dark-logo">
				<img src="../00_service_assets/main/images/deskapp-logo-white.svg" alt="" class="light-logo">
			</a>
			<div class="close-sidebar" data-toggle="left-sidebar-close">
				<i class="ion-close-round"></i>
			</div>
		</div>
		<div class="menu-block customscroll">
			<div class="sidebar-menu">				
				<ul id="accordion-menu">
					<li class="dropdown">
						<a href="javascript:;" class="dropdown-toggle">
							<span class="micon dw dw-house-1"></span><span class="mtext">Campus</span>
						</a>
						<ul class="submenu">
							<li><a href="../01_campus/index.html">To Campus</a></li>
							<li><a href="../14_minting/index.html">Minting</a></li>
							<li><a href="../07_marketplace/index.html">Marketplace</a></li>
							<li><a href="../08_courtyard/index.html">Courtyard</a></li>
							<li><a href="../11_gallery/index.html">Galleries</a></li>
							<li><a href="../07_marketplace/course_directory.html">Course Directory</a></li>
							<li><a href="../09_community/index.html">Communities</a></li>
							
						</ul>
					</li>
					<li class="dropdown">
						<a href="javascript:;" class="dropdown-toggle">
							<span class="micon dw dw-user"></span><span class="mtext">Home</span>
						</a>
						<ul class="submenu">
							<li><a href="../12_personal/profile.html">Profile</a></li>
							<li><a href="../12_personal/locker.html">Locker</a></li>
							<li><a href="../12_personal/colleagues.html">Colleagues</a></li>
							<li><a href="../12_personal/preferences.html">Preferences</a></li>
							
						</ul>
					</li>
					<li class="dropdown">
						<a href="javascript:;" class="dropdown-toggle">
							<span class="micon dw dw-edit2"></span><span class="mtext">Workroom</span>
						</a>
						<ul class="submenu">
							<li><a href="index.html">Dashboard</a></li>
							<li><a href="live_studio.html">Live Studio</a></li>
						</ul>
					</li>
					<li class="dropdown">
						<a href="javascript:;" class="dropdown-toggle">
							<span class="micon dw dw-school"></span><span class="mtext">School</span>
						</a>
						<ul class="submenu">
							<li><a href="../17_school/school_manager.html">School Manager</a></li>
						</ul>
					</li>
					<li class="dropdown">
						<a href="javascript:;" class="dropdown-toggle">
							<span class="micon dw dw-book-1"></span><span class="mtext">Courses</span>
						</a>
						<ul class="submenu">		
							<li><a href="../15_course/index.html">Course Manager</a></li>
							<li><a href="../15_course/course_creator.html">Create Course</a></li>							
						</ul>
					</li>
					<li class="dropdown">
						<a href="javascript:;" class="dropdown-toggle">
							<span class="micon dw dw-calendar-1"></span><span class="mtext">Events</span>
						</a>
						<ul class="submenu">
							<li><a href="../16_event/event_manager.html">Event Manager</a></li>
							<li><a href="../16_event/event_creator.html">Create Event</a></li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<div class="mobile-menu-overlay"></div>

	<div class="main-container">
		<div class="xs-pd-20-10 pd-ltr-20">
			<div class="page-header">
				<div class="row">
					<div class="col-md-6 col-sm-12">
						<div class="title">
							<h4>Web 3 Edi Live Studio</h4>
						</div>
				
					</div>
					<div class="col-md-6 col-sm-12 text-right">
						
					</div>
				</div>
			</div>		
			<div class="row">
				<div class="col-lg-4 col-md-6 col-sm-12 mb-50">					
					<div class="card-box height-130-p pd-20">
						<h4>Delivery Stage View</h4>						
						<video id="live_player" controls height="100%" width="100%" />						
					</div>
					&nbsp;
					<div class="card-box height-130-p pd-20">
					<div class="row"> 
						<div class="alert alert-warning col-md-12" role="alert">
							<small><b>Time NOW :</b> <span id="event_time_now_display"></span></small><br/>
							<small><b>Start Time :</b> <span id="event_start_time_display"></span></small><br/>
							<small><b>End Time :</b> <span id="event_end_time_display"></span></small><br/>
						</div>
					</div>
				</div>
				</div>
				<div class="col-lg-4 col-md-6 col-sm-12 mb-50">
					
					<div class="card-box height-130-p pd-30">
						<h4>Live Broadcast Controls</h4>
							<div class="row"> 																	
									<select class="custom-select col-md-6" id="event_broadcast_select">								
									</select>									
									<a href="#" id="select_broadcast_event_button" class="btn btn-info col-md-6">Select Event</a>																	
							</div>
							&nbsp;
							<div class="row"> 
								<b>Event : <span id="selected_event_title_display"></span></b>
							</div>
							&nbsp;
							 <!-- stream access (modal - stream key / playback id) -->	
							<div class="row">								
								<small><a href="#" class="btn btn-dark" id="stream_access_button" data-toggle="modal" data-target="#small-modal">stream access</a></small>								
								&nbsp;						
								<div class="alert alert-info col-md-3" role="alert">
									<small>Delivery Stage: <span id="event_delivery_stage"></span></small>
								</div>
								&nbsp;						
								<div class="alert alert-danger col-md-5" role="alert">
									<small>Live Status: <span id="event_live_status"></span></small>
								</div>
							</div>
							<div class="row"> 
								<div class="alert alert-info col-md-12" role="alert">
									<small>Promotions : <span id="event_promo_destinations"></span></small>
								</div>
							</div>
						
							<div class="row"> 
								<div class="alert alert-info col-md-12" role="alert">
									<a href="#" id="go_chain_live_button" class="btn btn-danger">Go Chain Live</a>
									<a href="#" id="end_chain_broadcast_button" class="btn btn-success">End Chain Broadcast</a>
									<a href="#" id="cancel_chain_broadcast_button" class="btn btn-warning">Cancel Chain Broadcast</a>
								</div>
							</div>
					
						
						 
						 <!-- recorded or not -->
						 <!-- delivery stage -->
						 <!-- promo destinations -->
						 <!-- start / end / cancel -->
					</div>
				</div>
				<div class="col-lg-4 col-md-6 col-sm-12 mb-30">					
					<div class="card-box height-130-p pd-20">
						<h4>Scheduled Events </h4>
						<span id="scheduled_events_display"></span>

					 <!-- event title -->
						<!-- start time  -->
						<!-- duration  -->
						<!-- view / start / cancel -->
					</div>
				</div>
			</div>
			<p>

			</p>
			<div class="row">
				<div class="col-lg-7 col-md-12 col-sm-12 mb-30">
					<div class="card-box pd-30 height-100-p">
							<h4>Live Broadcast Statistics</h4>
							<b>Event : <span id="event_title_display">Event</span></b>
							<!-- components-->
						<!-- session time remaining-->						 
						 <!-- current participants -->
						 <!-- current registrants--> 
						 <!-- max spaces --> 
							<div class="row">
								<div class="alert alert-primary col-md-3" role="alert">
									Session Time Remaining <span id="session_time_remaining"></span>
								</div>
								&nbsp;
								<div class="alert alert-secondary col-md-3" role="alert">
									<small></small>Participants: <span id="current_participants_display"></span>
								</div>
								&nbsp;
								<div class="alert alert-secondary col-md-3" role="alert">
									Registrants: <span id="current_registrants_display"></span>
								</div>
								&nbsp;
								<div class="alert alert-secondary col-md-2" role="alert">
									Max Spaces: <span id="max_spaces_display"></span>
								</div>
							</div>
					</div>
				</div>
				<div class="col-lg-5 col-md-12 col-sm-12 mb-30">
					<div class="card-box pd-30 height-100-p">
						<!-- components -->
						<h4>Create Quick Event</h4>
						Note: This operation triggers three separate metamask transactions.
						<span id="quick_live_message_span"></span> 
						<div class="row">
							<div class="col-md-6 col-sm-12">
								<div class="form-group">
									<label for="quick_event_title">Title</label>
									<input type="text" class="form-control" id="quick_event_title">
								</div>							
							</div>
							<div class="col-md-6 col-sm-12">
								<div class="form-group">
									<label for="quick_event_headline">Headline</label>
									<input type="text" class="form-control" id="quick_event_headline">
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6 col-sm-12">
								<div class="form-group">
									<label for="quick_event_categories">Categories</label>
									<input type="text" class="form-control" id="quick_event_categories">
								</div>							
							</div>
							<div class="col-md-6 col-sm-12">
								<div class="form-group">
									<label for="quick_event_duration">Duration</label>
									<select id="quick_event_duration" class="custom-select col-12">
											<option value="15">15 mins</option>
											<option value="30">30 mins</option>
											<option value="45">45 mins</option>
											<option value="60">60 mins</option>
									</select>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6 col-sm-12">
								<div class="form-group">
									<label for="quick_event_spaces">Spaces</label>
									<input type="number" class="form-control" id="quick_event_spaces">
								</div>							
							</div>
							<div class="col-md-6 col-sm-12">
								<div class="form-group">
									<label for="quick_event_stage">Delivery Stage</label>
									<select class="form-control" id="quick_event_stage"></select>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6 col-sm-12">
								<div class="form-group">
									<label for="quick_event_promo_destination">Promo Destinations</label>
									<div class="custom-control custom-checkbox mb-5">
										<input type="checkbox" class="custom-control-input" id="promotion_campus" value="CAMPUS">
										<label class="custom-control-label" for="promotion_campus">Campus</label>
									</div>
									<div class="custom-control custom-checkbox mb-5">
										<input type="checkbox" class="custom-control-input" id="promotion_candidate" value="CANDIDATE">
										<label class="custom-control-label" for="promotion_candidate">Candidate</label>
									</div>
								</div>							
							</div>
							<div class="col-md-6 col-sm-12">
								<label class="weight-600">Event Recorded</label>
									<div class="custom-control custom-radio mb-5">
										<input type="radio" id="customRadio1" name="quickEventRecorded" value="YES" class="custom-control-input">
										<label class="custom-control-label" for="customRadio1">YES</label>
									</div>
									<div class="custom-control custom-radio mb-5">
										<input type="radio" id="customRadio2" name="quickEventRecorded" value="NO" class="custom-control-input">
										<label class="custom-control-label" for="customRadio2">NO</label>
									</div>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6 col-sm-12">
								<div class="form-group">
									<a type="text" class="btn btn-warning" id="clear_quick_live_button">Clear Quick Live</a>
								</div>							
							</div>
							<div class="col-md-6 col-sm-12">
								<div class="form-group">									
									<a type="text" class="btn btn-danger" id="post_to_live_button">Post To Live</a>
								</div>
							</div>
						</div>
							<!-- quick event controls -->
						<!-- title -->
						<!-- headline -->
						<!-- categories -->
						<!-- duration-->
						<!-- spaces -->
						<!-- stage -->
						<!-- recorded -->
						<!-- promo destinations -->
						<!-- post now / -->

						
					</div>
				</div>
			</div>
			<div class="footer-wrap pd-20 mb-20 card-box">
				&copy; Web 3 Edi 2022
			</div>
		</div>
	</div>

	<!-- modal -->
	<div class="modal fade" id="small-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-sm modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title" id="myLargeModalLabel">Web 3 Edi Educator Stream Access Details</h4>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
				</div>
				<div class="modal-body">
					Stream Key : <span id="modal_stream_key_display"></span>
					<br/>
					Playback Id : <span id="modal_playback_id_display"></span>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	

	<!-- js -->

	<script src="../00_service_assets/main/scripts/core.js"></script>
	<script src="../00_service_assets/main/scripts/script.min.js"></script>
	<script src="../00_service_assets/main/scripts/process.js"></script>
	<script src="../00_service_assets/main/scripts/layout-settings.js"></script>

	<!-- Web 3 ABI-->
	<script src="../00_service_assets/abi/open_register/i_open_register_abi.js"></script>   

	<script src="../00_service_assets/abi/event/i_event_abi.js"></script>       
    <script src="../00_service_assets/abi/event/i_write_event_abi.js"></script>       
    <script src="../00_service_assets/abi/event/i_event_manager_abi.js"></script>
    <script src="../00_service_assets/abi/broadcast/i_broadcast_scheduler_abi.js"></script>
    <script src="../00_service_assets/abi/broadcast/i_broadcast_stream_manager_abi.js"></script>    

	<!-- Web 3 Edi -->
	<script src="../00_service_assets/main/js/web_3_edi.js"></script>
	
	<script> 
	 	const networkURL 					= "https://rinkeby-explorer.arbitrum.io/block/";
		const livePlayer 					= ge("live_player");
		const videoEl 						= document.querySelector("#live_player");
		const eventBroadcastSelect 			= ge("event_broadcast_select"); 
		const selectBroadcastEventButton 	= ge("select_broadcast_event_button");
		selectBroadcastEventButton.addEventListener('click', selectEventToBroadcast);

		const selectedEventTitleDisplay 	= ge("selected_event_title_display");
		const streamAccessButton 			= ge("stream_access_button");

		const eventDeliveryStageDisplay		= ge("event_delivery_stage");
		const eventLiveStatusDisplay		= ge("event_live_status");
		const eventPromoDestinationsDisplay = ge("event_promo_destinations");
		const eventStartTimeDisplay			= ge("event_start_time_display");
		const eventEndTimeDisplay			= ge("event_end_time_display");
		const timeNowDisplay				= ge("event_time_now_display");

		const goChainLiveButton				= ge("go_chain_live_button");
		goChainLiveButton.addEventListener('click', goChainLive);

		const endChainBroadcastButton		= ge("end_chain_broadcast_button");
		endChainBroadcastButton.addEventListener('click', endChainBroadcast);

		const cancelChainBroadcastButton	= ge("cancel_chain_broadcast_button");		
		cancelChainBroadcastButton.addEventListener('click', cancelChainBroadCast);

		const modalStreamKeyDisplay			= ge("modal_stream_key_display");
		const modalPlaybackIdDisplay		= ge("modal_playback_id_display");

		const scheduledEventsDisplay		= ge("scheduled_events_display");
		const sessionTimeRemaining			= ge("session_time_remaining"); 
		const currentParticipantsDisplay 	= ge("current_participants_display");
		const currentRegistrantsDisplay		= ge("current_registrants_display"); 
		const maxSpacesDisplay				= ge("max_spaces_display");	
		
		const quickEventTitleField				= ge("quick_event_title");
		const quickEventHeadlineField			= ge("quick_event_headline");
		const quickEventCategoriesField			= ge("quick_event_categories");
		const quickEventDurationField			= ge("quick_event_duration");

		const quickEventSpacesField				= ge("quick_event_spaces");
		const quickEventStageField				= ge("quick_event_stage");

		const promotionCampusField				= ge("promotion_campus");
		const promotionCandidateField			= ge("promotion_candidate");
		
		const postToLiveButton					= ge("post_to_live_button");
		postToLiveButton.addEventListener('click',postToLive);

		const clearQuickLiveButton				= ge("clear_quick_live_button");
		clearQuickLiveButton.addEventListener('click', clearQuickLive);

		const quickLiveMessageSpan				= ge("quick_live_message_span");

		var streamKey; 
		var playbackId; 

		var selectedEventAddress; 
		var selectedEventContract; 

		var broadcastSchedulerContract; 		
		var selectedStage; 
		var isLive; 

		var quickLiveAddress; 
		var quickLiveContract;

		async function configurePageContracts(){
            openRegistryContract.methods.getAddress("RESERVED_WEB_3_EDI_EVENT_MANAGER_CORE").call({
                from: account
            })
            .then(function(response) {
                console.log(response);
                eventManagerContract = getContract(iW3EEventManagerAbi, response);
            })
            .catch(function(err) {
                console.log(err);
            });
            openRegistryContract.methods.getAddress("RESERVED_WEB_3_EDI_STREAMING_MANAGER_CORE").call({
                from: account
            })
            .then(function(response) {
                console.log(response);
                streamingManagerContract = getContract(iW3EBroadcastStreamManagerAbi, response);
            })
            .catch(function(err) {
                console.log(err);
            });
			openRegistryContract.methods.getAddress("RESERVED_WEB_3_EDI_BROADCAST_SCHEDULER_CORE").call({
                from: account
            })
            .then(function(response) {
                console.log(response);
                broadcastSchedulerContract = getContract(iBroadcastScheduler, response);
            })
            .catch(function(err) {
                console.log(err);
            });
		}
	
		async function loadPageData() { 
			loadStreamDetails(); 
			getEventsWithStatus(eventBroadcastSelect, "PENDING", selectBroadcastEventButton);
			buildEventSchedule();
			buildQuickLiveStages();
			
		}
		async function loadStreamDetails()  { 

			streamingManagerContract.methods.hasStreamDetails().call({from : account})
			.then(function(response){
				console.log(response);
				modalStreamKeyDisplay.innerHTML = ""; 
				modalPlaybackIdDisplay.innerHTML = ""; 
				if(response === false) {
					// display get streaming details button 
					modalStreamKeyDisplay.innerHTML = "No stream details"; 
					modalPlaybackIdDisplay.innerHTML = "No stream details";                     
				}
				else { 
					streamingManagerContract.methods.getStreamDetails().call({from : account})
					.then(function(response){
						console.log(response);
						streamKey = response.streamKey;
						playbackId = response.playbackId;
						modalStreamKeyDisplay.innerHTML = streamKey;
						modalPlaybackIdDisplay.innerHTML = playbackId;
						runVideo(playbackId);
					})
					.catch(function(err){
						console.log(err);
					})
				}
			})
			.catch(function(err){
				console.log(err);
			})
		}

		async function activateStageVideo() {
			
			broadcastSchedulerContract.methods.getBroadcast(selectedStage).call({from : account})
			.then(function(response){
				console.log(response);
				runVideo(response.playbackId);
			})
			.catch(function(err){
				console.log(err);
			})
		}

		async function runVideo(pbid) { 
			var src = "https://livepeercdn.com/hls/"+pbid+"/index.m3u8";
			if (videoEl.canPlayType("application/vnd.apple.mpegurl")) {
				// Some browers (safari and ie edge) support HLS natively
				videoEl.src = src;
			} 
			else if (Hls.isSupported()) {
				const hls = new Hls();
				hls.loadSource(src);
				hls.attachMedia(videoEl);
			} 
			else {
				console.error("This is a legacy browser that doesn't support MSE");
			}
		}

		async function getEventsWithStatus(eventSelect, status, eventButton) { 
            eventManagerContract.methods.getEvents(status).call({
			    from: account
            })
            .then(function(response) {
                console.log(response);
				var filtered = filter(response);
				console.log(filtered);
                buildEventSelect(eventSelect, status, eventButton, filtered);
            })            
            .catch(function(err) {
                console.log(err);
                noStatusFound(eventSelect, status, eventButton); 

            })
        }

		function filter(addresses) {
			var filtered = []; 
			for(var x = 0; x < addresses.length; x++) {
				var eventAddress = addresses[x];
				if(eventAddress != '0x0000000000000000000000000000000000000000'){
					filtered.push(eventAddress);
				}
			}
			return filtered;
		}

		async function selectEventToBroadcast() {
			primeEventForBroadCast(eventBroadcastSelect.value);
		}

		async function buildEventSchedule() {
			eventManagerContract.methods.getEvents("PENDING").call({
			    from: account
            })
            .then(function(response) {
                console.log(response);
				var eventAddresses = response; 
				var filtered = filter(response);
				console.log(filtered);
                buildEventListing(filtered);
            })            
            .catch(function(err) {
                console.log(err);


            })
		}

		async function buildEventListing(eventAddresses) {
			scheduledEventsDisplay.innerHTML = ""; 
			for(var x = 0; x < eventAddresses.length; x++) {
				var eventAddress = eventAddresses[x];
				buildListing(eventAddress);
			}
		}

		function buildListing(eventAddress) {
			/*
			<div class="row"> 
				<div class="alert alert-info col-md-12" role="alert">
					<small>Event Title</small> 
					<small>Start Time: </small> 
					<small>End Time: </small> 
					
					<div class="dropdown">
						<a class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle" href="#" role="button" data-toggle="dropdown">
							<i class="dw dw-more"></i>
						</a>
						<div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
							<a class="dropdown-item" href="event_detail.html"><i class="dw dw-eye"></i> View</a>
							<a class="dropdown-item" href="event_creator.html"><i class="dw dw-edit2"></i> Edit</a>
							<a class="dropdown-item" href="#"><i class="dw dw-delete-3"></i> Delete</a>
						</div>
					</div>
				</div>
			</div>
			*/
			var eContract = getContract(iW3EEventAbi, eventAddress);

			var row = ce("div");
			row.setAttribute("class", "row");
			scheduledEventsDisplay.append(row);

			var alert = ce("div");
			row.append(alert);
			alert.setAttribute("class", "alert alert-info col-md-12");
			alert.setAttribute("role", "alert");
			
			var title = ce("small");
			alert.append(title);
			var b = ce("b");
			title.append(b);
			getTitle(b, eventAddress);
			
			alert.append(text(" "));
			
			var startTime = ce("small");
			alert.append(startTime);			
			setTimeDisplayValue(eContract, startTime, "START_TIME_KEY");

			alert.append(" >> ");

			var endTime = ce("small");
			alert.append(endTime);
			setTimeDisplayValue(eContract, endTime, "END_TIME_KEY");


			var dropdown = ce("div");
			dropdown.setAttribute("class", "dropdown");
			alert.append(dropdown);
			var a = ce("a"); 
			dropdown.append(a);
			a.setAttribute("class", "btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle");
			a.setAttribute("href", "#");
			a.setAttribute("role","button");
			a.setAttribute("data-toggle","dropdown");
			
			a.append(getIcon("dw dw-more"));
			var menu = ce("div");
			dropdown.append(menu);
			menu.setAttribute("class", "dropdown-menu dropdown-menu-right dropdown-menu-icon-list");
			var view = ce("a");
			menu.append(view);
			view.setAttribute("class","dropdown-item");
			view.setAttribute("href", "../16_event/event_detail?address="+eventAddress);
			view.append(getIcon("dw dw-eye"));
			view.append(text(" View"));

			var edit = ce("a");
			menu.append(edit);
			edit.setAttribute("class","dropdown-item");
			edit.setAttribute("href", "../16_event/event_creator?address="+eventAddress);
			edit.append(getIcon("dw dw-edit2"));
			edit.append(text(" Edit"));

			var del = ce("a");
			menu.append(del);
			del.setAttribute("class","dropdown-item");
			del.setAttribute("href", "#");
			del.append(getIcon("dw dw-delete-3")); 
			del.append(text(" Delete"));
		}

	
		async function goChainLive() {
			if(!isLive) {
				selectedEventContract.methods.execute("START").send({from : account})
				.then(function(response){
					console.log(response);
					eventLiveStatusDisplay.innerHTML = ""; 
					eventLiveStatusDisplay.append(text("ON CHAIN / ON AIR"));
					isLive = true; 
					buildEventStatistics(); 

				})
				.catch(function(err){
                	console.log(err);
            	})
			}			
		}

		async function endChainBroadcast() {
			
			selectedEventContract.methods.execute("END").send({from : account})
			.then(function(response){
				console.log(response);
				eventLiveStatusDisplay.innerHTML = ""; 
				eventLiveStatusDisplay.append(text("OFF CHAIN / OFF AIR"));
				isLive = false; 
				buildEndEventStatistics(); 

			})
			.catch(function(err){
				console.log(err);
			})			
		}

		async function cancelChainBroadCast() {
			
			selectedEventContract.methods.execute("CANCEL").send({from : account})
			.then(function(response){
				console.log(response);
				eventLiveStatusDisplay.innerHTML = ""; 
				eventLiveStatusDisplay.append(text("CANCELLED"));
				isLive = false; 
				buildEndEventStatistics(); 
			})
			.catch(function(err){
				console.log(err);
			})
			
		}

		async function clearQuickLive() { 

		}

		async function postToLive() { 			
			// create event 
			createEvent(quickLiveMessageSpan);					
		}


       // creat event
        async function createEvent(span) {
            eventManagerContract.methods.createEvent(quickEventTitleField.value,  streamKey, playbackId).send({from : account}) // switch back after next deploy
            .then(function(response){
                console.log(response);
                span.innerHTML = ""; 
                var blockNumber = response.blockNumber;                 
                span.append(getBlockLink(blockNumber));
				span.append(text(" Event Created. "));  
				// read address 
				getEvent(); 
            })
            .catch(function(err){
                console.log(err);
            })
        }

		async function getEvent() { 
 			eventManagerContract.methods.getEvents().call({from : account})
			.then(function(response){
				console.log(response);
				quickLiveAddress = response[response.length-1]; 
				quickLiveContract = getContract(iW3EWriteEventAbi, quickLiveAddress); // get the last one 
				console.log("event secured :: " + quickLiveAddress);
				// populate event 
				populateQuickEvent(quickLiveMessageSpan);				
			})
			.catch(function(err){
				console.log(err);
			})
		}

		const zero = ethers.constants.AddressZero;
		const noGuests = [];

		async function populateQuickEvent(span) { 
			var txtFieldNames    = [    
                                    "TITLE_KEY",
                                    "HEADLINE_KEY",
                                    "HOST_KEY", 
                                    "DELIVERY_STAGE_KEY", 
                                    "SUMMARY_IPFS_KEY",   // stock
                                    "DETAILS_IPFS_KEY",   // stock
                                    "PROMO_IMAGE_IPFS_KEY", // stock
                                    "PREVIEW_VIDEO_IPFS_KEY", // stock                           
                                    "RECORDED_KEY"                               
                                ];

        	var numericFieldNames = [
                                    "START_TIME_KEY",  // calculated + 2 mins
                                    "END_TIME_KEY",    // calculated + duration 
                                    "SPACES_KEY"
                                ];

			var txtFieldValues     =  [
                                        quickEventTitleField.value, 
                                        quickEventHeadlineField.value, 
                                        account, 
                                        quickEventStageField.value,
                                        "QmP99ZXXjgtisXdSmpieAcse4uKMym93XuqGbYg6sxEMyr", // event summary
                                        "QmP99ZXXjgtisXdSmpieAcse4uKMym93XuqGbYg6sxEMyr", // detailed event description 
										"QmYBJUvbfq1VjN7DK4Fe2dUWWqK1xqH4FXjhbijekwrZPo", // promo image
                                        "Qmd5pEJekZmmrZBVndH9wrfQkoN5WFYE2nF8qxHGRWnsEg", // promo video                                        
                                        document.querySelector('input[name="quickEventRecorded"]:checked').value                                      
                                      ];


									  var startTime = Date.now() + 120000;
									  var endTime = startTime + (quickEventDurationField.value * 60 * 1000);
									  console.log(startTime);
									  console.log(endTime);
            var numericFieldValues  = [
                                        Math.round(startTime / 1000), 
                                        Math.round(endTime / 1000),
                                        quickEventSpacesField.value
                                      ];
									  console.log(numericFieldValues);
									  console.log(getPromotionDestinations());
			quickLiveContract.methods.populate(txtFieldNames, txtFieldValues, 
                                                numericFieldNames, numericFieldValues,   
                                                getArray(quickEventCategoriesField.value), 
                                                noGuests,
                                                getPromotionDestinations(), 
                                                zero).send({from : account})
            .then(function(response){
                console.log(response);
				span.innerHTML = ""; 
                var blockNumber = response.blockNumber; 
                span.append(getBlockLink(blockNumber));
				span.append(text(" Event saved. "));
				
				// post event 
				postQuickEvent(quickLiveMessageSpan);
			})
            .catch(function(err){
                console.log(err);
            })
		}

		function postQuickEvent(span){
			quickLiveContract.methods.execute("POST").send({ from : account})
			.then(function(response){
				console.log(response);
				// display transaction 
				var blockNumber = response.blockNumber;
				span.append(getBlockLink(blockNumber));
				span.append(text(" Event Posted. ")); 

				// assign to Live 
				primeEventForBroadCast(quickLiveAddress); 
			})
			.catch(function(err){
				console.log(err);
			})
		}		

		function getArray(values) {
            return values.split(",");
        }

		async function buildQuickLiveStages() {
			broadcastSchedulerContract.methods.getAvailableStages().call({from : account})
			.then(function(response){
				console.log(response);
				quickEventStageField.innerHTML = ""; 
				for(var x = 0; x < response.length; x++) {
					var stage = response[x];
					var option = ce("option");
					option.setAttribute("value", stage );
					option.append(text(stage));
					quickEventStageField.append(option);
				}
			})
			.catch(function(err){
				console.log(err);
			})
		}

		function getPromotionDestinations() { 
            
            var destinations = []; 
            pushIfChecked(destinations, ge("promotion_campus"));
            pushIfChecked(destinations, ge("promotion_candidate"));
			/*
            pushIfChecked(destinations, ge("promotion_student"));
            pushIfChecked(destinations, ge("promotion_school"));
            pushIfChecked(destinations, ge("promotion_communities"));
            pushIfChecked(destinations, ge("promotion_courtyard"));
            pushIfChecked(destinations, ge("promotion_galleries"));
            pushIfChecked(destinations, ge("promotion_market_place"));
			*/
            return destinations; 
        }

        function pushIfChecked(d, f) {
            if(f.checked == true) {
               d.push(f.value);
            }
        }

		async function buildEndEventStatistics() { 
			setTimeRemaining(selectedEventContract, sessionTimeRemaining); 
			setNumericDisplayValue(selectedEventContract, currentParticipantsDisplay, "ALL_PARTICIPANTS_KEY");
			setNumericDisplayValue(selectedEventContract, currentRegistrantsDisplay, "ALL_REGISTRANTS_KEY");
		}

		async function buildEventStatistics() { 
			setTimeRemaining(selectedEventContract, sessionTimeRemaining); 
			setNumericDisplayValue(selectedEventContract, currentParticipantsDisplay, "CURRENT_PARTICIPANTS_KEY");
			setNumericDisplayValue(selectedEventContract, currentRegistrantsDisplay, "CURRENT_REGISTRANTS_KEY");
			setNumericDisplayValue(selectedEventContract, maxSpacesDisplay, "SPACES_KEY");
		}

		async function setNumericDisplayValue(eContract, component, fieldName){
            eContract.methods.getFeatureUINT(fieldName).call({from : account})
            .then(function(response){
                console.log(response);
                component.value = response; 
            })
            .catch(function(err){
                console.log(err);
            })
        }

		async function setTimeRemaining(eContract, sessionTimeRemaining) {
			sessionTimeRemaining.innerHTML = ""; 
			eContract.methods.getFeatureUINT("END_TIME_KEY").call({from : account})
			.then(function(response){
				console.log(response);
				var time = response * 1000; 
				var timeRemaining = time - Date.now(); 
				if(timeRemaining > 60000) {
					sessionTimeRemaining.append(text((timeRemaining / 60000) + " mins"));
				}
				else { 
					sessionTimeRemaining.append(text((timeRemaining / 1000) + " secs"));
				}
			})
			.catch(function(err){
				console.log(err);
			})
		}

        function getBlockLink(blockNumber) {
            var url = networkURL + blockNumber +"/transactions";  
			var a = ce("a");
			a.setAttribute("href", url);
			a.setAttribute("target", "_blank");
			a.append(text(blockNumber));
            return a;
        }

		function getIcon(cls) {
			var ic = ce("i");
			ic.setAttribute("class",cls);
			return ic; 
		}

		async function buildEventSelect(eventSelect, eventStatus, button, eventAddresses) {
            eventSelect.innerHTML = ""; 
            if(eventAddresses.length > 0) {            
                for(var x = 0; x < eventAddresses.length; x++) {
                    var eventAddress = eventAddresses[x];
                    var option = ce("option");
                    option.setAttribute("value", eventAddress);
                    var span = ce("span");
                    option.append(span);
                    option.append(text( " :: " + eventAddress ));                
                    getTitle(span, eventAddress);
                    eventSelect.append(option);                    
                }
                button.disabled = false; 
                button.setAttribute("class", "btn btn-primary");
            }
            else { 
                noStatusFound(eventSelect, eventStatus, button);
            }

        }

		function noStatusFound(eventSelect, eventStatus, button) { 
            var option = ce("option");
                option.setAttribute("default", "true");
                option.append(text("No "+eventStatus+" Events Found"));
                eventSelect.append(option);
                eventSelect.disabled = true; 
                button.setAttribute("class", "btn btn-light");
                button.disabled = true; 
        }
		
		async function getTitle(span, eAddress) {
            eContract = getContract(iW3EEventAbi, eAddress);
            eContract.methods.getTitle().call({from : account})
            .then(function(response){
                console.log(response);
                span.append(text(response));
            })
            .catch(function(err){
                console.log(err);
            })
        }

		function clear(c) {
			c.innerHTML = ""; 
		}

		async function primeEventForBroadCast(sea) {			
			selectedEventAddress = sea; 
			selectedEventContract= getContract(iW3EEventAbi, selectedEventAddress);
			// set event 
			selectedEventTitleDisplay.innerHTML = ""; 
			getTitle(selectedEventTitleDisplay, selectedEventAddress);

			// display stage 
			clear(eventDeliveryStageDisplay); 
			setTextDisplayValue(selectedEventContract, eventDeliveryStageDisplay, "DELIVERY_STAGE_KEY" );

			// live status 
			setLiveStatus(selectedEventContract);

			// prmotion destinations 
			clear(eventPromoDestinationsDisplay);
			setArrayDisplayValues(selectedEventContract,eventPromoDestinationsDisplay, "PROMOTION_DESTINATIONS_KEY" );

			clear(eventStartTimeDisplay);
			setTimeDisplayValue(selectedEventContract, eventStartTimeDisplay, "START_TIME_KEY");

			clear(eventEndTimeDisplay);
			setTimeDisplayValue(selectedEventContract, eventEndTimeDisplay, "END_TIME_KEY");
			
			clear(timeNowDisplay);
			timeNowDisplay.append(text(new Date(Date.now())));
		}

		async function setLiveStatus(selectedEventContract) { 			
            // status 
            eContract.methods.getStatus().call({from : account})
            .then(function(response){
                console.log(response); 
				clear(eventLiveStatusDisplay);               
                eventLiveStatusDisplay.append(text(resolveOnAirStatus(response)));
            })
            .catch(function(err){
                console.log(err);
            })
		}

		async function setTimeDisplayValue(eContract, component, fieldName){
            eContract.methods.getFeatureUINT(fieldName).call({from : account})
            .then(function(response){
                console.log(response);
                component.append(text(getTime(response))); 
            })
            .catch(function(err){
                console.log(err);
            })
        }

		function resolveOnAirStatus( status ) {
			if(status === "PENDING"){ 
				return "NOT STARTED "; 
			}
			if(status === "STARTED"){ 
				return "ON AIR - ON CHAIN "; 
			}
			if(status === "ENDED"){ 
				return "OFF AIR - OFF CHAIN "; 
			}

			if(status === "CANCELLED"){ 
				return "ABORTED "; 
			}
		}

		
        function concatArray(strs) {
            var result = ""; 
            for(var x = 0; x < strs.length; x++) {
                result = result.concat(",", strs[x]);                
            }
            result = result.substring(1,result.length);
            console.log("concat :: ");
            return result; 
        }

        async function setTextDisplayValue(eContract, component, fieldName){
            eContract.methods.getFeatureSTR(fieldName).call({from : account})
            .then(function(response){
                console.log(response);
                component.append(text(response)); 
            })
            .catch(function(err){
                console.log(err);
            })
        }

		async function setArrayDisplayValues(eContract, component, fieldName) {
            eContract.methods.getFeatureSTRARRAY(fieldName).call({from : account})
            .then(function(response){
                console.log(response);
                component.append(text(concatArray(response)));
            })
            .catch(function(err){
                console.log(err);
            })
        }

		function getTime(numeric) {
            var d = new Date(numeric*1000);
            return formatDate(d);
        }
        function formatDate(date) {
            return date.toLocaleString('en-UK', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', hour12: false, minute: '2-digit', second: '2-digit' })
        }
        function ge(id) {
            return document.getElementById(id);
        }

        function text(txt) {
            return document.createTextNode(txt);
        }

        function ce(name) {
            return document.createElement(name);
        }
	</script>
</body>
</html>
